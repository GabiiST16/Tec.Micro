
.INCLUDE "m328pdef.inc"

.equ F_CPU   = 16000000
.equ BAUD    = 9600
.equ UBRRVAL = 103       

.CSEG
.ORG 0x0000
    RJMP RESET

RESET:
    LDI R16, LOW(RAMEND)
    OUT SPL, R16
    LDI R16, HIGH(RAMEND)
    OUT SPH, R16


    LDS R16, DDRD
    LDI R16, 0XFC
    OUT DDRD, R16
	LDI R16, 0X00
	OUT PORTD, R16
    LDI R16, LOW(UBRRVAL)
    STS UBRR0L, R16
    LDI R16, HIGH(UBRRVAL)
    STS UBRR0H, R16

    LDI R16, (1<<RXEN0) | (1<<TXEN0)
    STS UCSR0B, R16


    LDI R16, (1<<UCSZ01) | (1<<UCSZ00)
    STS UCSR0C, R16

    RJMP MAIN_LOOP


MAIN_LOOP:
    RCALL USART_RX      

    CPI R17, '1'
    BREQ Trian
    CPI R17, '2'
    BREQ Cruz
    CPI R17, '3'
    BREQ Circulo
    CPI R17, 'T'
    BREQ Todos

    RCALL USART_TX
    RJMP MAIN_LOOP
Trian:
	RCALL pos
	RCALL Tri
    RJMP MAIN_LOOP

Cruz:
	RCALL Pos
	RCALL Equis
    RJMP MAIN_LOOP
Circulo:
	RCALL Pos
	RCALL Cir
    RJMP MAIN_LOOP
Todos:
	RCALL Tod
	RJMP MAIN_LOOP

USART_TX:
TX_WAIT:
    LDS R16, UCSR0A       
    SBRS R16, UDRE0       
    RJMP TX_WAIT
    STS UDR0, R17         
    RET

USART_RX:
RX_WAIT:
    LDS R16, UCSR0A
    SBRS R16, RXC0        
    RJMP RX_WAIT
    LDS R17, UDR0         
    RET

Mseg:
    LDI R21, 254
    LDI R22, 254
    LDI R23, 254
L1:
    DEC R23
    BRNE L1
    DEC R22
    BRNE L1
    DEC R21
    BRNE L1
    NOP
    RET

Pos:
	LDI R17, 0X00
	LDI R17, 0X80
	OUT PORTD, R17
	RCALL Mseg
	RCALL Mseg
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	LDI R17, 0X10
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	RET
tri:
	LDI R17, 0X00
	LDI R17, 0X04
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	LDI R17, 0X14
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	LDI R17, 0X44
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	LDI R17, 0XA4
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X08
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	RET

Equis:
	LDI R17, 0X00
	LDI R17, 0X04
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	LDI R17, 0X54
	OUT PORTD, R17
	RCALL Mseg
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	LDI R17, 0XA8
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	LDI R17, 0X60
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	LDI R17, 0X04
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	LDI R17, 0X94
	OUT PORTD, R17
	RCALL Mseg
	RCALL Mseg
	LDI R17, 0X08
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	RET

M4:
	RCALL M1
	RCALL M1
	RCALL M1
	RCALL M1
    NOP
    RET
Mp:
    LDI R21, 40
    LDI R22, 254
    LDI R23, 254
L3:
    DEC R23
    BRNE L3
    DEC R22
    BRNE L3
    DEC R21
    BRNE L3
    NOP
    RET

M2:
	RCALL M1
	RCALL M1
    NOP
    RET
M1:
    LDI R21, 4
    LDI R22, 254
    LDI R23, 254
L4:
    DEC R23
    BRNE L4
    DEC R22
    BRNE L4
    DEC R21
    BRNE L4
    NOP
    RET
M3:
	RCALL M1
	RCALL M1
	RCALL M1
	NOP
	RET
Cir:
	LDI R17, 0X00
	LDI R17, 0X04
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	RCALL IZQ
	RCALL Mp
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M4
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M2
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M3
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M2
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M2
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M2
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M2
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M3
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M2
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL M4
	RCALL IZQ
	RCALL M1
	RCALL AB
	RCALL Mp
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M4
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M2
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M3
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M2
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M2
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M2
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M2
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M3
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M2
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL M4
	RCALL AB
	RCALL M1
	RCALL DER
	RCALL Mp
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M4
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M2
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M3
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M2
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M2
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M2
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M2
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M3
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M2
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL M4
	RCALL DER
	RCALL M1
	RCALL AR
	RCALL Mp
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M4
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M2
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M3
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M2
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M2
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M2
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M2
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M1
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M3
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M2
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M4
	RCALL AR
	RCALL M1
	RCALL IZQ
	RCALL M2
	LDI R17, 0X08
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	RET
AB:
	LDI R17, 0X00
	LDI R17, 0X14
	OUT PORTD, R17
	RET
DER:
	LDI R17, 0X00
	LDI R17, 0X44
	OUT PORTD, R17
	RET
IZQ:
	LDI R17, 0X00
	LDI R17, 0X84
	OUT PORTD, R17
	RET
AR:
	LDI R17, 0X00
	LDI R17, 0X24
	OUT PORTD, R17
	RET
Post:
	LDI R17, 0X00
	LDI R17, 0X80
	OUT PORTD, R17
	RCALL Mseg
	RCALL Mseg
	RCALL Mseg
	RCALL Mseg
	RCALL Mseg
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	LDI R17, 0X10
	OUT PORTD, R17
	RCALL Mseg
	LDI R17, 0X00
	OUT PORTD, R17
	RET
Tod:
	RCALL Post
	RCALL tri
	LDI R17, 0X40
	OUT PORTD, R17
	RCALL Mseg
	RCALL Mseg
	RCALL EQUIS
	LDI R17, 0X60
	OUT PORTD, R17
	RCALL Mseg
	RCALL Mseg
	LDI R17, 0X40
	OUT PORTD, R17
	RCALL Mseg
	RCALL Cir
	RET
