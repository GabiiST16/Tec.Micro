#define F_CPU 16000000UL

#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include <util/delay.h>
#include <string.h>

// --- Definiciones ---
#define baud 9600
#define ubr 103
#define LED 6
#define WIDTH 8
#define HEIGHT 8
#define NUM_LEDS (WIDTH * HEIGHT)

const uint8_t anim1_numFrames = 12;
const int anim1_tiempoFrame = 250;

const uint8_t anim2_numFrames = 10;
const int anim2_tiempoFrame = 150; // Más rápido para el cohete


volatile char comando_recibido = '0'; // '0'=Test, '1'=Alien, '2'=Cohete
volatile uint32_t milisegundos_contador = 0;

int animacionActual = 0; // 0=Test/Detenido, 1=Alien, 2=Cohete
int frameActual = 0;
uint32_t tiempoFrameAnterior = 0;
int velocidadFrames = 1000;
uint8_t numFramesActual = 0;

uint8_t leds[NUM_LEDS][3];

void USART_Init(unsigned int ubrr);
void USART_Transmit(unsigned char data);
void USART_SendString(const char *str);
void sendBit(uint8_t bitVal);
void sendByte(uint8_t byte);
void show(uint8_t (*colors)[3]);
void setLedRGB(uint8_t (*leds_buf)[3], int ledIndex, uint8_t r, uint8_t g, uint8_t b);
void fillAllLedsRGB(uint8_t r, uint8_t g, uint8_t b);


const uint8_t alien_frame1[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame2[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame3[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame4[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame5[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame6[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame7[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame8[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame9[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame10[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame11[NUM_LEDS][3] PROGMEM;
const uint8_t alien_frame12[NUM_LEDS][3] PROGMEM;

const uint8_t CoheteF1[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF2[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF3[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF4[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF5[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF6[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF7[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF8[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF9[NUM_LEDS][3] PROGMEM;
const uint8_t CoheteF10[NUM_LEDS][3] PROGMEM;

void timer1_millis_init(void);
uint32_t get_millis(void);
void probarColores(void);
void mostrarFrame(const uint8_t (* const* animacion)[3], uint8_t numFrame);
void revisarComandosSerial(void);
void actualizarAnimacion(void);


int main(void) {
	//pin de la matriz PD6
	DDRD |= (1 << LED);
	
	// Iniciar Periféricos
	USART_Init(ubr);
	timer1_millis_init(); //contador de tiempo
	
	// Habilitar interrupciones globales
	sei();
	
	USART_SendString("\r\nSistema de Animacion\r\n");
	USART_SendString("Enviar '1' (Alien), '2' (Cohete) o '0' (Test)\r\n");
	
	// Prueba de inicio
	probarColores();
	
	while (1) {
		revisarComandosSerial();
		actualizarAnimacion();
	}
}

void USART_Init(unsigned int ubrr)
{
	UBRR0H = (unsigned char)(ubrr >> 8);
	UBRR0L = (unsigned char)ubrr;
	UCSR0B = (1 << RXEN0) | (1 << TXEN0) | (1 << RXCIE0);
	UCSR0C = (1 << UCSZ01) | (1 << UCSZ00);
}

void USART_Transmit(unsigned char data)
{
	while (!(UCSR0A & (1 << UDRE0)));
	UDR0 = data;
}

void USART_SendString(const char *str)
{
	while (*str)
	{
		USART_Transmit(*str++);
	}
}


void sendBit(uint8_t bitVal)
{
	if (bitVal) {
		PORTD |= (1 << LED);
		asm volatile("nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t");
		PORTD &= ~(1 << LED);
		asm volatile("nop\n\t""nop\n\t""nop\n\t""nop\n\t");
		} else {
		PORTD |= (1 << LED);
		asm volatile("nop\n\t""nop\n\t""nop\n\t");
		PORTD &= ~(1 << LED);
		asm volatile("nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t""nop\n\t");
	}
}
void sendByte(uint8_t byte)
{
	for (uint8_t i = 0; i < 8; i++)
	{
		sendBit(byte & (1 << (7 - i)));
	}
}

void show(uint8_t (*colors)[3])
{
	cli();
	for (int i = 0; i < NUM_LEDS; i++)
	{
		sendByte(colors[i][1]); // Verde
		sendByte(colors[i][0]); // Rojo
		sendByte(colors[i][2]); // Azul
	}
	sei();
	_delay_us(60);
}

void setLedRGB(uint8_t (*leds_buf)[3], int ledIndex, uint8_t r, uint8_t g, uint8_t b)
{
	if (ledIndex < 0 || ledIndex >= NUM_LEDS) return;
	leds_buf[ledIndex][0] = r;
	leds_buf[ledIndex][1] = g;
	leds_buf[ledIndex][2] = b;
}

void fillAllLedsRGB(uint8_t r, uint8_t g, uint8_t b)
{
	for (int i = 0; i < NUM_LEDS; i++)
	{
		setLedRGB(leds, i, r, g, b);
	}
}

const uint8_t alien_frame1[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame2[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame3[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame4[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame5[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,0,0},
	{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame6[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame7[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},
	{0,0,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},
};
const uint8_t alien_frame8[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame9[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,0,0},
	{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame10[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
};
const uint8_t alien_frame11[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},
	{0,0,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},
};
const uint8_t alien_frame12[NUM_LEDS][3] PROGMEM = {
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,255,0},{0,0,0},
	{0,0,0},{0,255,0},{0,0,0},{0,255,0},{0,255,0},{0,0,0},{0,255,0},{0,0,0},
	{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},{0,255,0},{0,0,0},{0,0,0},
};

const uint8_t (* const animacion1[])[3] PROGMEM = {
	alien_frame1, alien_frame2, alien_frame3, alien_frame4, alien_frame5,
	alien_frame6, alien_frame7, alien_frame8, alien_frame9, alien_frame10,
	alien_frame11, alien_frame12,
};



const uint8_t CoheteF1[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{150,150,150},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{150,150,150},	{150,150,150},	{150,150,150},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF2[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{150,150,150},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{150,150,150},	{150,150,150},	{150,150,150},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF3[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{255,0,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{0,0,0},	{150,150,150},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{150,150,150},	{150,150,150},	{150,150,150},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF4[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{255,0,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{150,150,150},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{150,150,150},	{150,150,150},	{150,150,150},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF5[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{255,0,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{150,150,150},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{150,150,150},	{150,150,150},	{150,150,150},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF6[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{150,150,150},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{150,150,150},	{150,150,150},	{150,150,150},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{255,0,0},	{255,255,0},	{255,0,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF7[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{150,150,150},	{150,150,150},	{150,150,150},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{255,0,0},	{255,255,0},	{255,0,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{255,255,0},	{255,255,0},	{255,255,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF8[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{255,255,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{255,0,0},	{255,255,0},	{255,0,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{255,255,0},	{255,255,0},	{255,255,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,0,0},	{255,255,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{255,255,0},	{255,255,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF9[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{255,255,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{255,0,0},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{255,255,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};
const uint8_t CoheteF10[NUM_LEDS][3] PROGMEM = {
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},	{0, 80, 200},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},	{0,0,0},
};

const uint8_t (* const animacion2[])[3] PROGMEM = {
	CoheteF1, CoheteF2, CoheteF3, CoheteF4, CoheteF5,
	CoheteF6, CoheteF7, CoheteF8, CoheteF9, CoheteF10,
};

ISR(USART_RX_vect) {
	char cmd = UDR0;
	if (cmd == '0' || cmd == '1' || cmd == '2') {
		comando_recibido = cmd;
	}
}


void timer1_millis_init(void) {
	TCCR1B = (1 << WGM12);
	OCR1A = 249;
	TIMSK1 = (1 << OCIE1A);
	TCCR1B |= (1 << CS11) | (1 << CS10);
}


ISR(TIMER1_COMPA_vect) {
	milisegundos_contador++;
}

uint32_t get_millis(void) {
	uint32_t ms;
	cli();
	ms = milisegundos_contador;
	sei();
	return ms;
}


void probarColores(void) {
	animacionActual = 0; // Detiene la animación
	fillAllLedsRGB(150, 0, 0); // Rojo
	show(leds);
	_delay_ms(500);
	
	fillAllLedsRGB(0, 150, 0); // Verde
	show(leds);
	_delay_ms(500);
	
	fillAllLedsRGB(0, 0, 150); // Azul
	show(leds);
	_delay_ms(500);
	
	fillAllLedsRGB(0, 0, 0); // Apagar
	show(leds);
}

void mostrarFrame(const uint8_t (* const* animacion)[3], uint8_t numFrame) {
	const void* frame_ptr = pgm_read_ptr(&animacion[numFrame]);
	uint8_t* ram_ptr = (uint8_t*)leds;
	const uint8_t* pgm_ptr = (const uint8_t*)frame_ptr;
	
	for (int i = 0; i < (NUM_LEDS * 3); i++) {
		uint8_t byte_leido = pgm_read_byte(&pgm_ptr[i]);
		ram_ptr[i] = byte_leido;
	}
	show(leds);
}


void revisarComandosSerial(void) {
	if (comando_recibido != 0) {
		char cmd = comando_recibido;
		comando_recibido = 0;
		
		frameActual = 0;
		tiempoFrameAnterior = get_millis();
		
		if (cmd == '1') {
			animacionActual = 1;
			velocidadFrames = anim1_tiempoFrame;
			numFramesActual = anim1_numFrames;
			USART_SendString("Iniciando Animacion 1 (Alien)\r\n");
			
			} else if (cmd == '0') {
			animacionActual = 0;
			USART_SendString("Comando 0: Prueba de colores\r\n");
			probarColores();
			
			} else if (cmd == '2'){
			animacionActual = 2;
			velocidadFrames = anim2_tiempoFrame;
			numFramesActual = anim2_numFrames;
			USART_SendString("Iniciando animacion 2 (Cohete)\r\n");
		}
	}
}

void actualizarAnimacion(void) {
	if (animacionActual == 0) return;
	
	uint32_t tiempoActual = get_millis();
	
	if (tiempoActual - tiempoFrameAnterior >= velocidadFrames) {
		tiempoFrameAnterior = tiempoActual;
		
		if (animacionActual == 1) {
			mostrarFrame(animacion1, frameActual);
			} else if (animacionActual == 2) {
			mostrarFrame(animacion2, frameActual);
		}
		frameActual++;
		if (frameActual >= numFramesActual) {
			frameActual = 0;
		}
	}
}